<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Dashboard 1</title>
  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { 
      font-family: Arial, sans-serif; background: #f4f6fa; color: #232323; 
    }
    .dashboard-container { 
      max-width: 1200px; margin: 40px auto; background: #fff; box-shadow: 0 2px 12px #eee;
      border-radius: 10px; padding: 30px;
    }
    .select-row { display: flex; gap: 30px; margin-bottom: 24px; align-items: flex-start; }
    .column { flex: 1; background: #eaf4fb; border-radius: 8px; padding: 18px; }
    .form-section { display: flex; align-items: center; gap: 16px; margin-top: 12px; }
    .submit-reset { margin-top: 18px; display: flex; gap: 12px; }
    button { background: #1976d2; color: #fff; padding: 10px 20px; border: none; border-radius: 4px; }
    button:active, button:hover { background: #0d5691; }
    .checkbox-list, .taluka-list { max-height: 140px; overflow-y: auto; }
    .taluka-btn { display: inline-block; margin: 4px; background: #98c6ef; color: #fff; border: none; border-radius: 16px; padding: 8px 14px; cursor: pointer;}
    .taluka-btn.selected { background: #1976d2; }
    .kpi-row { display: flex; gap: 30px; margin-bottom: 30px; margin-top: 22px;}
    .kpi-block { flex: 1; background: #e2f6da; border-radius: 8px; text-align: center; padding: 24px 0; font-size: 1.2em; display: flex; flex-direction: column; align-items: center;}
    .kpi-block.emoji-1 { background: #fff4c6;}
    .kpi-block.emoji-2 { background: #e4eaff;}
    .kpi-block .emoji { font-size: 2em; margin-bottom: 6px; }
    .charts-row { display: flex; gap: 30px; }
    .chart-container { flex: 1; background: #f7ebdf; border-radius: 8px; padding: 14px; }
    .data-table { width:100%; border-collapse: collapse; margin-top:36px;}
    .data-table th, .data-table td { padding: 10px 14px; border: 1px solid #dbe3e7; background: #fafcff;}
    .data-table th { background: #1976d2; color: #fff;}
    .filter-highlight { background: #e6f3fa; font-weight: bold; }
    @media (max-width: 900px) {
      .select-row, .kpi-row, .charts-row { flex-direction: column; gap: 16px;}
    }
  </style>
</head>
<body>
  <div class="dashboard-container">
    <div class="select-row">
      <!-- Column 1: Scheme Dropdown + Checkboxes -->
      <div class="column">
        <label for="scheme-select"><b>Select Schemes:</b></label>
        <div class="checkbox-list" id="scheme-checkboxes">
          <!-- These will be populated from fetched data -->
        </div>
        <div class="submit-reset">
          <button onclick="submitSelections()">Submit</button>
          <button onclick="resetSelections()">Reset</button>
        </div>
      </div>
      <!-- Column 2: Taluka Multi-Select as Buttons -->
      <div class="column">
        <label for="taluka-select"><b>Select Taluka:</b></label>
        <div class="taluka-list" id="taluka-buttons">
          <!-- These will be populated from fetched data -->
        </div>
      </div>
    </div>
    <!-- KPIs Section -->
    <div class="kpi-row" id="kpi-row">
      <div class="kpi-block emoji-1"><span class="emoji">ü•á</span><b>Top 5</b><div id="kpi-top">-</div></div>
      <div class="kpi-block emoji-2"><span class="emoji">‚ú®</span><b>Middle 5</b><div id="kpi-middle">-</div></div>
      <div class="kpi-block" style="background: #ffc9e6;"><span class="emoji">üîª</span><b>Bottom 5</b><div id="kpi-bottom">-</div></div>
    </div>
    <!-- Charts Section -->
    <div class="charts-row">
      <div class="chart-container">
        <canvas id="rankChart" width="350" height="225"></canvas>
      </div>
      <div class="chart-container">
        <canvas id="schemeChart" width="350" height="225"></canvas>
      </div>
    </div>
    <!-- Interactive Table -->
    <table class="data-table" id="dataTable">
      <thead>
        <tr>
          <th>Sr.</th>
          <th>Schemes</th>
          <th>Taluka</th>
          <th>Rank</th>
          <th>Score</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody>
        <!-- Table rows will be inserted here -->
      </tbody>
    </table>
  </div>
<script>
const API_KEY = "AIzaSyD1zkB93JoLUrNX7nN2qEcavFRE-P1r9Eg";
const SHEET_ID = "1y_EVqNg-reS3xV-Kn6cmTou7u_6kuyqykNdgdzXEMkE";
const SHEET_RANGE = "Rank!BF5:AI5"; // Change if your sheet headers/data are in a different range

let rawData = [];
let schemeSet = new Set();
let talukaSet = new Set();
let rankChart, schemeChart;

function getStatusEmoji(status) {
  // Map status to emoji (Adjust mapping as needed)
  if (status === "Yes" || status === "‚úîÔ∏è") return "‚úîÔ∏è";
  if (status === "No" || status === "üîª") return "üîª";
  return status;
}

// Fetch data and initialize dashboard
function fetchDataAndInit() {
  fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${SHEET_RANGE}?key=${API_KEY}`)
    .then(response => response.json())
    .then(json => {
      const values = json.values;
      if (!values || values.length === 0) {
        alert("No data found in the sheet range.");
        return;
      }

      // Example parsing - adjust for your exact sheet columns
      // Here, each value[0] is assumed like: ['Scheme', 'Taluka', 'Rank', 'Score', 'Status', ...]
      const header = values[0];
      const dataRows = values.slice(1);
      rawData = [];
      schemeSet.clear();
      talukaSet.clear();

      // If your sheet has more rows, change this accordingly!
      for (const row of dataRows) {
        let scheme = row[0] || "";
        let taluka = row[1] || "";
        let rank = parseInt(row[2] || 0, 10);
        let score = parseInt(row[3] || 0, 10);
        let status = getStatusEmoji(row[4] || "");
        rawData.push({ scheme, taluka, rank, score, status });
        schemeSet.add(scheme);
        talukaSet.add(taluka);
      }
      // Populate selectors
      populateSchemes();
      populateTalukas();

      // Initial dashboard draw (full data)
      updateDashboard(rawData);
    })
    .catch(error => {
      alert("‚ùå Error fetching data: " + error);
      console.error(error);
    });
}

function populateSchemes() {
  const scDiv = document.getElementById("scheme-checkboxes");
  scDiv.innerHTML = "";
  let idx = 0;
  for (let scheme of Array.from(schemeSet)) {
    if (!scheme) continue;
    scDiv.innerHTML += `<label><input type="checkbox" name="scheme" value="${scheme}"> ${scheme}</label><br>`;
    idx++;
  }
}
function populateTalukas() {
  const tDiv = document.getElementById("taluka-buttons");
  tDiv.innerHTML = "";
  for (let taluka of Array.from(talukaSet)) {
    if (!taluka) continue;
    tDiv.innerHTML += `<button class="taluka-btn" onclick="toggleTaluka(this)">${taluka}</button>`;
  }
}

function toggleTaluka(btn) {
  btn.classList.toggle('selected');
}

function resetSelections() {
  document.querySelectorAll('#scheme-checkboxes input[type=checkbox]')
    .forEach(cb => cb.checked = false);
  document.querySelectorAll('.taluka-btn').forEach(b => b.classList.remove('selected'));
  updateDashboard(rawData);
}

function submitSelections() {
  let selectedSchemes = Array.from(document.querySelectorAll('#scheme-checkboxes input[type=checkbox]:checked')).map(x => x.value);
  let selectedTalukas = Array.from(document.querySelectorAll('.taluka-btn.selected')).map(x => x.innerText);

  let filtered = rawData.filter(row => {
    let scFilter = selectedSchemes.length === 0 || selectedSchemes.includes(row.scheme);
    let tFilter = selectedTalukas.length === 0 || selectedTalukas.includes(row.taluka);
    return scFilter && tFilter;
  });
  updateDashboard(filtered);
}

/* --- Chart and Table Updating Logic --- */
function updateDashboard(data) {
  // KPIs: sort by Rank and get blocks
  let sorted = [...data].sort((a, b) => a.rank - b.rank);
  let top5 = sorted.slice(0, 5);
  let middle5 = sorted.slice(5, 10);
  let bottom5 = sorted.slice(-5);

  document.getElementById('kpi-top').innerText = top5.reduce((sum, r) => sum + r.score, 0); // Or whatever logic you want
  document.getElementById('kpi-middle').innerText = middle5.reduce((sum, r) => sum + r.score, 0);
  document.getElementById('kpi-bottom').innerText = bottom5.reduce((sum, r) => sum + r.score, 0);

  // --- Chart: Ranks (bar) ---
  let rankLabels = top5.map(r => r.scheme + " (" + r.taluka + ")");
  let rankScores = top5.map(r => r.rank);
  if (rankChart) rankChart.destroy();
  rankChart = new Chart(document.getElementById('rankChart'), {
    type: 'bar',
    data: {
      labels: rankLabels,
      datasets: [{
        label: 'Rank',
        data: rankScores,
        backgroundColor: '#1976d2'
      }]
    },
    options: { 
      responsive: false, 
      plugins: { legend: {display: false}},
      scales: { y: { beginAtZero: true, reverse: false } }
    }
  });

  // --- Chart: Schemes (pie) ---
  let schemeCounts = {};
  for (let r of data) {
    if (r.scheme) schemeCounts[r.scheme] = (schemeCounts[r.scheme] || 0) + 1;
  }
  let schemePieLabels = Object.keys(schemeCounts);
  let schemePieData = Object.values(schemeCounts);
  let colors = ['#ffd54f', '#64b5f6', '#e57373', '#81c784', '#ba68c8', '#f06292', '#fff176', '#4dd0e1', '#8d6e63', '#dce775'];
  if (schemeChart) schemeChart.destroy();
  schemeChart = new Chart(document.getElementById('schemeChart'), {
    type: 'pie',
    data: {
      labels: schemePieLabels,
      datasets: [{
        data: schemePieData,
        backgroundColor: colors
      }]
    },
    options: { responsive:false }
  });

  // --- Table ---
  const tbody = document.getElementById('dataTable').getElementsByTagName('tbody')[0];
  tbody.innerHTML = "";
  data.forEach((row, i) => {
    let status = getStatusEmoji(row.status);
    tbody.innerHTML += `
      <tr>
        <td>${i + 1}</td>
        <td>${row.scheme}</td>
        <td>${row.taluka}</td>
        <td>${row.rank}</td>
        <td>${row.score}</td>
        <td>${status}</td>
      </tr>
    `;
  });
}

// First load
fetchDataAndInit();
</script>
</body>
</html>
